---
# - name: Проверка наличия файла '/root/.ssh/id_rsa'
  # stat:
    # path: /root/.ssh/id_rsa
  # register: id_rsa_result

# - name: Добавление прав root-у на доступ по ssh и соседние ключей
  # block:
  
  # - name: Внесение изменений в /etc/ssh/sshd_config
    # lineinfile: 
      # dest: /etc/ssh/sshd_config
      # regexp: '^{{ item.src }}'
      # insertbefore: BOF
      # line: '{{ item.dest }}'
    # loop:
      # - { src: "#PermitRootLogin", dest: "PermitRootLogin yes" }

  # - name: change password
    # user:
      # name: root
      # state: present
      # password: "{{ pass.root | password_hash('sha512') }}"

  # - name: Перезапуск службы ssh
    # service:
      # name: ssh
      # enabled: yes
      # state: restarted

  # - name: Инсталляция пакета 'sshpass'
    # apt:
      # name:
      # - sshpass
      # state: latest
      # update_cache: yes

  # - name: Удаление ssh ключей
    # shell: rm -Rf /root/.ssh/id_rsa*
    # ignore_errors: yes

  # - name: Генерация ssh ключей '/root/.ssh/id_rsa'
    # shell: echo -e "\n" | ssh-keygen -q -t rsa -f /root/.ssh/id_rsa -C "" -N ""
  
  # when: not id_rsa_result.stat.exists

# - name: Копирование ключей на соседние машины
  # shell: |
    # {% for item in ansible_play_batch %}
    # sshpass -p '{{ root_pass }}' ssh-copy-id -f -i ~/.ssh/id_rsa.pub -o "StrictHostKeyChecking=no" root@{{ hostvars[item].ansible_ssh_host }}
    # {% endfor %}




- name: Инсталляция необходимых пакетов
  apt:
    name:
    - sshpass
    state: latest
    update_cache: yes

- name: Проверка наличия '/etc/sudoers.d/{{ ansible_ssh_user }}'
  stat:
    path: /etc/sudoers.d/{{ ansible_ssh_user }}
  register: sudoers_result

- name:
  block:

  - name: Генерация ssh ключа пользователю '{{ ansible_ssh_user }}'
    shell: echo -e "\n" | ssh-keygen -q -t rsa -f /home/{{ ceph.user }}/.ssh/id_rsa -C "" -N ""
        
  - name: Создание прав sudo пользователю '{{ ansible_ssh_user }}'
    shell: |
      echo "{{ ansible_ssh_user }} ALL = (root) NOPASSWD:ALL" > /etc/sudoers.d/{{ ansible_ssh_user }}
      chmod 0440 /etc/sudoers.d/{{ ansible_ssh_user }}
#     pdpl-user -i 63 {{ ansible_ssh_user }}

  - name: Внесение изменений в конфигурационныйе файл '/etc/ssh/ssh_config'
    shell: echo 'StrictHostKeyChecking  no' >> /etc/ssh/ssh_config

  - name: Копирование ключей на сервера
    shell: |
      {% for item in ansible_play_batch %}
      sshpass -p '{{ ansible_ssh_pass }}' ssh-copy-id -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ ansible_ssh_user }}@{{ hostvars[item].ansible_ssh_host }}
      {% endfor %}
    become: true
    become_method: su
    become_user: '{{ ansible_ssh_user }}'
    vars:
      ansible_become_pass: '{{ ansible_ssh_pass }}'
    ignore_errors: yes